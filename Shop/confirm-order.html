<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>确认订单 - 农资商城</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-50">
    <header class="bg-gradient-to-r from-emerald-600 to-green-600 text-white shadow-lg relative">
        <div class="container mx-auto px-4">
            <div class="flex items-center justify-between py-4">
                <div class="flex items-center space-x-3">
                    <button id="mobile-menu-btn" class="md:hidden text-white hover:text-emerald-200 transition">
                        <i class="fas fa-bars text-2xl"></i>
                    </button>
                    <i class="fas fa-leaf text-2xl md:text-3xl"></i>
                    <div class="cursor-pointer" onclick="window.location.href='index.html'">
                        <h1 class="text-xl md:text-2xl font-bold">农资商城</h1>
                        <p class="text-xs text-emerald-100 hidden sm:block">专业农资电商平台</p>
                    </div>
                </div>
                <div class="flex items-center space-x-3 md:space-x-6">
                    <a href="#" class="flex items-center space-x-1 hover:text-emerald-200">
                        <i class="fas fa-shopping-cart text-lg"></i>
                        <span class="hidden sm:inline">购物车</span>
                        <span class="bg-red-500 text-xs px-2 py-0.5 rounded-full">3</span>
                    </a>
                    <!-- 我的农资下拉菜单 -->
                    <div class="dropdown">
                        <a href="#" class="flex items-center space-x-1 hover:text-emerald-200">
                            <i class="fas fa-user text-lg"></i>
                            <span class="hidden sm:inline">张三</span>
                        </a>
                        <div class="dropdown-menu">
                            <a href="#" class="block py-1 px-4 text-sm" onclick="window.location.href='user-center.html'">买家中心</a>
                            <a href="#" class="block py-1 px-4 text-sm" onclick="window.location.href='seller-choice.html'">卖家中心</a>
                        </div>
                    </div>
                    
                    <!-- 登录按钮 -->
                    <a href="login.html" class="flex items-center space-x-1 hover:text-emerald-200">
                        <i class="fas fa-sign-in-alt text-lg"></i>
                        <span class="hidden sm:inline">登录</span>
                    </a>
                    
                    <!-- 免费注册按钮 -->
                    <a href="register.html" class="flex items-center space-x-1 hover:text-emerald-200">
                        <i class="fas fa-user-plus text-lg"></i>
                        <span class="hidden sm:inline">注册</span>
                    </a>
                </div>
            </div>
            <style>
                /* 确保导航栏容器不会限制下拉菜单显示 */
                header {
                    overflow: visible !important;
                    position: relative;
                    z-index: 9999;
                }
                
                nav {
                    overflow: visible !important;
                    z-index: 9999;
                }
                
                .container {
                    overflow: visible !important;
                }
                
                .dropdown {
                    position: relative;
                    z-index: 9999;
                    display: inline-block;
                }
                
                .dropdown-menu {
                    display: none;
                    background: white;
                    border-radius: 0.5rem;
                    box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
                    padding: 0.5rem 0;
                    margin: 0;
                    min-width: 150px;
                    z-index: 9999;
                    /* 关键：使用fixed定位完全脱离文档流 */
                    position: fixed;
                }
                
                /* 二级下拉菜单样式 */
                .group .dropdown-menu {
                    position: absolute;
                    left: 100%;
                    top: 0;
                    margin-left: 0.5rem;
                }
                
                .group:hover .dropdown-menu {
                    display: block;
                }
                
                /* 使下拉菜单在悬停时显示 */
                .dropdown:hover .dropdown-menu {
                    display: block;
                }
                
                /* 下拉菜单项样式 */
                .dropdown-menu a {
                    color: #374151;
                    text-decoration: none;
                    transition: all 0.2s ease;
                }
                
                .dropdown-menu a:hover {
                    background-color: #f3f4f6;
                    color: #059669;
                }
            </style>
        </div>
    </header>

    <main class="container mx-auto px-4 py-6">
        <h2 class="text-xl font-bold text-gray-800 mb-6">确认订单</h2>

        <!-- 收货地址 -->
        <div class="bg-white rounded-lg shadow-md p-4 mb-6">
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-medium text-gray-800">收货地址</h3>
                <button class="text-sm text-emerald-600 hover:text-emerald-700" onclick="showAddressModal()">
                    <i class="fas fa-edit mr-1"></i>选择地址
                </button>
            </div>
            <div class="flex items-start space-x-4">
                <div class="bg-emerald-100 text-emerald-600 p-2 rounded-full">
                    <i class="fas fa-home"></i>
                </div>
                <div>
                    <p class="font-medium">张三</p>
                    <p class="text-sm text-gray-600">13800138000</p>
                    <p class="text-sm text-gray-600">山东省菏泽市牡丹区曹州路123号 农业科技园区 1号楼3单元501室</p>
                </div>
            </div>
        </div>

        <!-- 订单商品 -->
        <div class="bg-white rounded-lg shadow-md p-4 mb-6">
            <h3 class="font-medium text-gray-800 mb-4">订单商品</h3>
            
            <!-- 店铺1 -->
            <div class="mb-6">
                <div class="flex items-center space-x-3 mb-4 pb-2 border-b border-gray-100">
                    <img src="https://picsum.photos/seed/shop1/40/40" alt="店铺logo" class="w-10 h-10 object-cover rounded-full">
                    <div class="flex-1">
                        <h4 class="text-sm font-medium text-gray-800">曹州农资旗舰店</h4>
                        <div class="flex items-center space-x-4 text-xs text-gray-500 mt-1">
                            <span><i class="fas fa-star text-yellow-400 mr-1"></i>4.8</span>
                            <span><i class="fas fa-truck mr-1"></i>24小时发货</span>
                            <span><i class="fas fa-shield-alt mr-1"></i>正品保障</span>
                        </div>
                    </div>
                    <button class="text-xs text-emerald-600 hover:text-emerald-700">进店逛逛</button>
                </div>
                <div class="space-y-4">
                    <!-- 商品1 -->
                    <div class="flex items-center space-x-4">
                        <img src="https://picsum.photos/seed/agri1/100/100" alt="小麦种子" class="w-20 h-20 object-cover rounded-md">
                        <div class="flex-1">
                            <h4 class="text-sm font-medium text-gray-800">优质小麦种子 高产抗倒伏 适合山东地区种植</h4>
                            <p class="text-xs text-gray-500 mt-1">50kg/袋</p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm text-emerald-600 font-medium">¥128.00</p>
                            <p class="text-xs text-gray-500">x2</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 店铺2 -->
            <div>
                <div class="flex items-center space-x-3 mb-4 pb-2 border-b border-gray-100">
                    <img src="https://picsum.photos/seed/shop2/40/40" alt="店铺logo" class="w-10 h-10 object-cover rounded-full">
                    <div class="flex-1">
                        <h4 class="text-sm font-medium text-gray-800">绿源化肥专营店</h4>
                        <div class="flex items-center space-x-4 text-xs text-gray-500 mt-1">
                            <span><i class="fas fa-star text-yellow-400 mr-1"></i>4.9</span>
                            <span><i class="fas fa-truck mr-1"></i>48小时发货</span>
                            <span><i class="fas fa-shield-alt mr-1"></i>正品保障</span>
                        </div>
                    </div>
                    <button class="text-xs text-emerald-600 hover:text-emerald-700">进店逛逛</button>
                </div>
                <div class="space-y-4">
                    <!-- 商品2 -->
                    <div class="flex items-center space-x-4">
                        <img src="https://picsum.photos/seed/agri2/100/100" alt="复合肥" class="w-20 h-20 object-cover rounded-md">
                        <div class="flex-1">
                            <h4 class="text-sm font-medium text-gray-800">高氮高钾复合肥 蔬菜专用 促进生长</h4>
                            <p class="text-xs text-gray-500 mt-1">25kg/袋</p>
                        </div>
                        <div class="text-right">
                            <p class="text-sm text-emerald-600 font-medium">¥85.00</p>
                            <p class="text-xs text-gray-500">x1</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 配送方式 -->
        <div class="bg-white rounded-lg shadow-md p-4 mb-6">
            <h3 class="font-medium text-gray-800 mb-4">配送方式</h3>
            <div class="flex items-center space-x-4">
                <input type="radio" id="delivery" name="delivery" checked class="w-4 h-4 text-emerald-600">
                <label for="delivery" class="flex-1 text-sm">
                    <span class="font-medium">快递配送</span>
                    <span class="text-xs text-gray-500 ml-2">预计3-5天送达</span>
                </label>
                <span class="text-sm">¥10.00</span>
            </div>
        </div>

        <!-- 支付方式 -->
        <div class="bg-white rounded-lg shadow-md p-4 mb-6">
            <h3 class="font-medium text-gray-800 mb-4">支付方式</h3>
            <div class="space-y-3">
                <div class="flex items-center space-x-4">
                    <input type="radio" id="wechat" name="payment" checked class="w-4 h-4 text-emerald-600">
                    <label for="wechat" class="flex items-center text-sm">
                        <i class="fab fa-weixin text-green-600 text-xl mr-2"></i>
                        <span>微信支付</span>
                    </label>
                </div>
                <div class="flex items-center space-x-4">
                    <input type="radio" id="alipay" name="payment" class="w-4 h-4 text-emerald-600">
                    <label for="alipay" class="flex items-center text-sm">
                        <i class="fab fa-alipay text-blue-600 text-xl mr-2"></i>
                        <span>支付宝</span>
                    </label>
                </div>
                <div class="flex items-center space-x-4">
                    <input type="radio" id="bank" name="payment" class="w-4 h-4 text-emerald-600">
                    <label for="bank" class="flex items-center text-sm">
                        <i class="fas fa-credit-card text-purple-600 text-xl mr-2"></i>
                        <span>银行卡支付</span>
                    </label>
                </div>
            </div>
        </div>

        <!-- 订单备注 -->
        <div class="bg-white rounded-lg shadow-md p-4 mb-6">
            <h3 class="font-medium text-gray-800 mb-2">订单备注</h3>
            <textarea placeholder="请输入订单备注信息..." class="w-full px-3 py-2 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-2 focus:ring-emerald-500"></textarea>
        </div>

        <!-- 订单总计 -->
        <div class="bg-white rounded-lg shadow-md p-4 mb-20">
            <div class="space-y-2">
                <div class="flex justify-between text-sm">
                    <span class="text-gray-600">商品金额</span>
                    <span>¥341.00</span>
                </div>
                <div class="flex justify-between text-sm">
                    <span class="text-gray-600">配送费</span>
                    <span>¥10.00</span>
                </div>
                <div class="flex justify-between text-sm">
                    <span class="text-gray-600">优惠券</span>
                    <span class="text-red-600">-¥20.00</span>
                </div>
                <div class="border-t border-gray-200 pt-3 mt-2">
                    <div class="flex justify-between text-lg font-bold">
                        <span>实付款</span>
                        <span class="text-emerald-600">¥331.00</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- 提交订单按钮 -->
        <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-4 shadow-lg">
            <div class="container mx-auto flex items-center justify-between">
                <div>
                    <span class="text-sm text-gray-600">实付款：</span>
                    <span class="text-lg font-bold text-emerald-600">¥331.00</span>
                </div>
                <button class="bg-emerald-600 text-white px-8 py-3 rounded-lg font-medium hover:bg-emerald-700 transition" onclick="window.location.href='payment.html'">
                    确认支付
                </button>
            </div>
        </div>
    </main>
    
    <!-- 地址选择弹窗 -->
    <div id="addressModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-2xl max-h-[80vh] overflow-y-auto">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-xl font-bold text-gray-800">选择收货地址</h3>
                <button class="text-gray-500 hover:text-gray-700" onclick="closeAddressModal()">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>
            
            <!-- 提示信息 -->
            <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-4">
                <div class="flex items-start space-x-2">
                    <i class="fas fa-info-circle text-yellow-600 mt-1"></i>
                    <div class="text-sm text-yellow-800">
                        <p>当前订单包含区域保护商品，您只能选择以下支持的地址。</p>
                        <p class="text-xs text-yellow-700 mt-1">选择地址后，系统将自动为您分配本地服务商。</p>
                    </div>
                </div>
            </div>
            
            <!-- 地址列表 -->
            <div class="space-y-3">
                <!-- 地址1 -->
                <div class="border rounded-lg p-4 cursor-pointer hover:border-emerald-500 transition" onclick="selectAddress('张三', '138****8888', '山东省菏泽市曹县XX镇XX村XX号', 1)">
                    <div class="flex items-start space-x-2">
                        <i class="fas fa-check-circle text-green-500 mt-1"></i>
                        <div class="flex-1">
                            <p class="text-sm font-medium text-gray-800">张三 138****8888</p>
                            <p class="text-xs text-gray-600">山东省菏泽市曹县XX镇XX村XX号</p>
                            <p class="text-xs text-green-600 mt-1">支持区域保护，将由曹县农业科技有限公司服务</p>
                        </div>
                    </div>
                </div>
                
                <!-- 地址2 -->
                <div class="border rounded-lg p-4 cursor-pointer hover:border-emerald-500 transition" onclick="selectAddress('张三', '138****8888', '山东省济南市历下区泉城路1号', 2)">
                    <div class="flex items-start space-x-2">
                        <i class="fas fa-check-circle text-green-500 mt-1"></i>
                        <div class="flex-1">
                            <p class="text-sm font-medium text-gray-800">张三 138****8888</p>
                            <p class="text-xs text-gray-600">山东省济南市历下区泉城路1号</p>
                            <p class="text-xs text-green-600 mt-1">支持区域保护，将由济南农资配送中心服务</p>
                        </div>
                    </div>
                </div>
                
                <!-- 地址3 -->
                <div class="border rounded-lg p-4 cursor-pointer hover:border-emerald-500 transition" onclick="selectAddress('张三', '138****8888', '北京市朝阳区建国路88号', 3)">
                    <div class="flex items-start space-x-2">
                        <i class="fas fa-check-circle text-green-500 mt-1"></i>
                        <div class="flex-1">
                            <p class="text-sm font-medium text-gray-800">张三 138****8888</p>
                            <p class="text-xs text-gray-600">北京市朝阳区建国路88号</p>
                            <p class="text-xs text-green-600 mt-1">支持区域保护，将由北京绿色农业发展有限公司服务</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 新增地址按钮 -->
            <div class="mt-4 text-center">
                <button class="w-full border border-dashed border-emerald-500 text-emerald-600 py-3 rounded-lg font-medium hover:bg-emerald-50 transition">
                    <i class="fas fa-plus mr-1"></i>新增收货地址
                </button>
            </div>
        </div>
    </div>
    
    <!-- 区域保护弹窗 -->
    <div id="regionProtectionModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-md w-full mx-4">
            <div class="text-center">
                <div class="w-16 h-16 bg-emerald-100 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-map-marker-alt text-2xl text-emerald-600"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-800 mb-2">区域保护通知</h3>
                <p class="text-gray-600 mb-6" id="protectionMessage">根据您的位置，您的订单已由本地服务商【XXX公司】为您服务</p>
                <div class="space-y-3">
                    <button class="w-full bg-emerald-600 text-white py-3 rounded-lg font-medium hover:bg-emerald-700 transition" onclick="confirmRegionProtection()">
                        确认
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 地址选择相关功能
        let selectedAddressId = 1;
        
        // 显示地址选择弹窗
        function showAddressModal() {
            document.getElementById('addressModal').classList.remove('hidden');
        }
        
        // 关闭地址选择弹窗
        function closeAddressModal() {
            document.getElementById('addressModal').classList.add('hidden');
        }
        
        // 选择地址
        function selectAddress(name, phone, address, addressId) {
            // 更新显示的地址
            const addressContainer = document.querySelector('.bg-white.rounded-lg.shadow-md.p-4.mb-6 .flex.items-start.space-x-4');
            if (addressContainer) {
                const infoDiv = addressContainer.querySelector('div:last-child');
                if (infoDiv) {
                    infoDiv.querySelector('p:first-child').textContent = name;
                    infoDiv.querySelector('p:nth-child(2)').textContent = phone;
                    infoDiv.querySelector('p:last-child').textContent = address;
                }
            }
            
            // 更新全局变量selectedAddressId
            selectedAddressId = addressId;
            
            // 关闭地址弹窗
            closeAddressModal();
            
            // 检查区域保护
            checkRegionProtection(address, addressId);
        }
        
        // 检查区域保护
        function checkRegionProtection(address, addressId) {
            // 模拟不同地区的区域保护规则
            const regionProtectionMap = {
                1: { // 曹县地址
                    protected: true,
                    serviceProvider: '曹县农业科技有限公司',
                    message: '根据您的位置，您的订单已由本地服务商【曹县农业科技有限公司】为您服务'
                },
                2: { // 济南地址
                    protected: true,
                    serviceProvider: '济南农资配送中心',
                    message: '根据您的位置，您的订单已由本地服务商【济南农资配送中心】为您服务'
                },
                3: { // 北京地址
                    protected: true,
                    serviceProvider: '北京绿色农业发展有限公司',
                    message: '根据您的位置，您的订单已由本地服务商【北京绿色农业发展有限公司】为您服务'
                }
            };
            
            const protectionInfo = regionProtectionMap[addressId];
            if (protectionInfo && protectionInfo.protected) {
                // 显示区域保护弹窗
                const messageElement = document.getElementById('protectionMessage');
                messageElement.textContent = protectionInfo.message;
                document.getElementById('regionProtectionModal').classList.remove('hidden');
            }
        }
        
        // 确认区域保护
        function confirmRegionProtection() {
            document.getElementById('regionProtectionModal').classList.add('hidden');
            // 更新当前页面的店铺信息
            updateShopInformation();
            // 保存区域信息到本地存储，以便购物车页面使用
            localStorage.setItem('selectedRegionId', selectedAddressId.toString());
            console.log('区域信息已保存到本地存储:', selectedAddressId);
            // 实际项目中这里会更新订单信息和金额
        }
        
        // 更新店铺信息
        function updateShopInformation() {
            // 商品与服务商的映射关系，实际项目中这部分数据应该从后端获取
            const productServiceProviderMap = {
                // 商品1: 优质小麦种子 - 属于区域保护商品
                '优质小麦种子 高产抗倒伏 适合山东地区种植': {
                    1: '曹县农业科技有限公司',  // 曹县地址对应的服务商
                    2: '济南农资配送中心',      // 济南地址对应的服务商
                    3: '北京绿色农业发展有限公司'  // 北京地址对应的服务商
                },
                // 商品2: 高氮高钾复合肥 - 属于区域保护商品
                '高氮高钾复合肥 蔬菜专用 促进生长': {
                    1: '曹县农业科技有限公司',
                    2: '济南农资配送中心',
                    3: '北京绿色农业发展有限公司'
                },
                // 非区域保护商品可以保持原服务商
                '其他非区域保护商品': null
            };
            
            // 服务商详细信息
            const serviceProviderDetails = {
                '曹县农业科技有限公司': {
                    id: 'shop3',
                    rating: '4.9',
                    deliveryTime: '24小时发货',
                    logo: 'https://picsum.photos/seed/shop3/40/40'
                },
                '济南农资配送中心': {
                    id: 'shop4',
                    rating: '4.8',
                    deliveryTime: '48小时发货',
                    logo: 'https://picsum.photos/seed/shop4/40/40'
                },
                '北京绿色农业发展有限公司': {
                    id: 'shop5',
                    rating: '4.7',
                    deliveryTime: '72小时发货',
                    logo: 'https://picsum.photos/seed/shop5/40/40'
                },
                '曹州农资旗舰店': {
                    id: 'shop1',
                    rating: '4.8',
                    deliveryTime: '24小时发货',
                    logo: 'https://picsum.photos/seed/shop1/40/40'
                },
                '绿源化肥专营店': {
                    id: 'shop2',
                    rating: '4.9',
                    deliveryTime: '48小时发货',
                    logo: 'https://picsum.photos/seed/shop2/40/40'
                }
            };
            
            // 获取所有店铺容器
            const shopContainers = document.querySelectorAll('.mb-6');
            
            // 遍历每个店铺
            shopContainers.forEach(shopContainer => {
                // 获取店铺内的所有商品
                const productItems = shopContainer.querySelectorAll('.flex.items-center.space-x-4');
                
                // 检查店铺内是否有区域保护商品
                let hasRegionProtectedProduct = false;
                let assignedServiceProvider = null;
                
                productItems.forEach(productItem => {
                    const productNameElement = productItem.querySelector('.text-sm.font-medium.text-gray-800');
                    if (productNameElement) {
                        const productName = productNameElement.textContent.trim();
                        const providerMap = productServiceProviderMap[productName];
                        
                        if (providerMap && providerMap[selectedAddressId]) {
                            hasRegionProtectedProduct = true;
                            assignedServiceProvider = providerMap[selectedAddressId];
                        }
                    }
                });
                
                // 如果店铺内有区域保护商品，更新店铺信息
                if (hasRegionProtectedProduct && assignedServiceProvider) {
                    const providerDetails = serviceProviderDetails[assignedServiceProvider];
                    if (providerDetails) {
                        // 更新店铺logo
                        const shopLogo = shopContainer.querySelector('.w-10.h-10.object-cover.rounded-full');
                        if (shopLogo) {
                            shopLogo.src = providerDetails.logo;
                        }
                        
                        // 更新店铺名称
                        const shopName = shopContainer.querySelector('.text-sm.font-medium.text-gray-800');
                        if (shopName) {
                            shopName.textContent = assignedServiceProvider;
                        }
                        
                        // 更新店铺评分和配送信息
                        const shopInfo = shopContainer.querySelectorAll('.text-xs.text-gray-500');
                        if (shopInfo.length >= 2) {
                            shopInfo[0].innerHTML = `<i class="fas fa-star text-yellow-400 mr-1"></i>${providerDetails.rating}`;
                            shopInfo[1].innerHTML = `<i class="fas fa-truck mr-1"></i>${providerDetails.deliveryTime}`;
                        }
                    }
                }
                // 非区域保护商品保持原服务商信息
            });
        }
        
        // 关闭所有弹窗
        function closeAllModals() {
            closeAddressModal();
        }
        
        // 点击弹窗外部关闭
        window.addEventListener('click', function(e) {
            const addressModal = document.getElementById('addressModal');
            const regionProtectionModal = document.getElementById('regionProtectionModal');
            
            if (e.target === addressModal) {
                closeAddressModal();
            } else if (e.target === regionProtectionModal) {
                regionProtectionModal.classList.add('hidden');
            }
        });
    </script>
</body>
</html>